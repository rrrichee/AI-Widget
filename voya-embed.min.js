/*! Voya Embed Widget v0.1 (no React, no deps) */
(function(){
  const CSS = `
  .voya-widget{position:fixed;z-index:2147483000;right:20px;bottom:20px;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .voya-card{width:360px;max-width:95vw;box-shadow:0 10px 30px rgba(0,0,0,.18);border-radius:12px;overflow:hidden;background:#fff;border:1px solid #e5e7eb}
  .voya-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;color:#fff}
  .voya-header .brand{display:flex;gap:8px;align-items:center;font-weight:700}
  .voya-body{padding:12px}
  .voya-list{height:260px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:4px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  .voya-bubble{max-width:280px;padding:10px 12px;border-radius:10px;line-height:1.35;white-space:pre-wrap}
  .voya-bubble.me{align-self:flex-end;color:#fff}
  .voya-bubble.bot{align-self:flex-start;background:#f3f4f6;color:#111827}
  .voya-row{display:flex;gap:8px;margin-top:10px}
  .voya-input{flex:1;border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px}
  .voya-btn{border:0;border-radius:8px;padding:10px 12px;cursor:pointer}
  .voya-quick{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .voya-chip{border:1px solid #e5e7eb;background:#fff;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:12px}
  .voya-toggle{background:rgba(255,255,255,.15);border:0;color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer}
  `;

  function h(tag, attrs={}, children=[]){
    const el = document.createElement(tag);
    for (const k in attrs) {
      if (k === "style" && typeof attrs[k] === "object") Object.assign(el.style, attrs[k]);
      else if (k.startsWith("on") && typeof attrs[k]==="function") el.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
      else if (attrs[k] !== undefined && attrs[k] !== null) el.setAttribute(k, attrs[k]);
    }
    if (!Array.isArray(children)) children=[children];
    children.forEach(c => {
      if (c == null) return;
      if (typeof c === "string") el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  }

  function VoyaEmbed(config){
    const apiBase = config.apiBase;
    if (!apiBase) throw new Error("Voya widget: missing apiBase");
    const brand = config.brandColor || "#5E60E6";
    const welcome = config.welcomeMessage || "Hi, I'm Voya. Ask me about flights and hotels!";

    if (!document.getElementById("voya-widget-style")) {
      const style = h("style", {id:"voya-widget-style"}, CSS);
      document.head.appendChild(style);
    }

    const root = h("div", {class:"voya-widget"});
    const card = h("div", {class:"voya-card"});
    const header = h("div", {class:"voya-header", style:{background:brand}},
      [h("div", {class:"brand"}, ["Voya ", h("span",{style:{opacity:.85,fontSize:"12px",fontWeight:500}}, "VoyageM8")]),
       h("button",{class:"voya-toggle", onclick:toggle}, "–")]
    );
    const body = h("div", {class:"voya-body"});
    const list = h("div", {class:"voya-list"});
    const quick = h("div", {class:"voya-quick"});
    const row = h("div", {class:"voya-row"});
    const input = h("input", {class:"voya-input", placeholder:"Ask Voya…"});
    const sendBtn = h("button", {class:"voya-btn", style:{background:brand,color:"#fff"}}, "Send");

    function bubble(text, me=false){
      const b = h("div", {class:"voya-bubble " + (me?"me":"bot"), style: me? {background:brand} : {}}, text);
      return b;
    }
    function scrollBottom(){ list.scrollTop = list.scrollHeight; }
    function addMsg(role, text){ list.appendChild(bubble(text, role==="user")); scrollBottom(); }

    addMsg("assistant", welcome);

    const hints = [
      {label:"Find NYC → LON 10/1", text:"Find me flights from NYC to LON on 2025-10-01"},
      {label:"Save as “London Getaway”", text:"Save this as: London Getaway"},
      {label:"Add Hotels", text:"Add hotels to London Getaway"},
      {label:"Show Trips", text:"List my saved trips"}
    ];
    hints.forEach(q => quick.appendChild(h("button",{class:"voya-chip", onclick:()=>send(q.text)}, q.label)));

    async function send(text){
      const t = (text || input.value || "").trim();
      if (!t) return;
      input.value="";
      addMsg("user", t);
      const typing = h("div",{style:{opacity:.7,alignSelf:"flex-start",fontSize:"13px"}}, "Voya is typing…");
      list.appendChild(typing); scrollBottom();
      try{
        const r = await fetch(apiBase, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify({ text: t })
        });
        const data = await r.json().catch(()=>({reply:"(No response)"}));
        typing.remove();
        addMsg("assistant", (data && data.reply) ? String(data.reply) : "Sorry, I had trouble responding.");
      }catch(e){
        typing.remove();
        addMsg("assistant","Network error. Please try again.");
      }
    }

    function toggle(){
      if (body.style.display === "none") { body.style.display="block"; this.textContent="–"; }
      else { body.style.display="none"; this.textContent="+"; }
    }

    sendBtn.addEventListener("click", ()=>send());
    input.addEventListener("keydown", (e)=>{ if (e.key==="Enter") send(); });

    row.appendChild(input); row.appendChild(sendBtn);
    body.appendChild(list); body.appendChild(quick); body.appendChild(row);
    card.appendChild(header); card.appendChild(body);
    root.appendChild(card); document.body.appendChild(root);

    return { destroy(){ root.remove(); } };
  }

  window.VOYAEMBED = { init: function(opts){ return VoyaEmbed(opts || {}); } };

  try{
    const current = document.currentScript || (function(){ const s=document.getElementsByTagName('script'); return s[s.length-1]; })();
    if (current) {
      const apiBase = current.getAttribute("data-api-base");
      const brandColor = current.getAttribute("data-brand");
      const welcomeMessage = current.getAttribute("data-welcome");
      if (apiBase) VOYAEMBED.init({apiBase, brandColor, welcomeMessage});
    }
  }catch(e){ /* ignore */ }
})();
